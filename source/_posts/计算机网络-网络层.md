---
title: '计算机网络-网络层'
date: 2019-03-18 13:52:09
tags:
	- 计算机网络
categories: 
	- 计算机网络
	- 计算机网络理论
---


# 概述

因为网络层是整个互联网的核心，因此应当让网络层尽可能简单。网络层向上只提供简单灵活的、无连接的、尽最大努力交互的数据报服务。

使用 IP 协议，**可以把异构的物理网络连接起来**，使得在网络层看起来好像是一个统一的网络。

{%asset_img 01.png%}

与 IP 协议配套使用的还有三个协议：

- 地址解析协议 ARP（Address Resolution Protocol）
- 网际控制报文协议 ICMP（Internet Control Message Protocol）
- 网际组管理协议 IGMP（Internet Group Management Protocol）

# IP 数据报格式

{%asset_img 02.jpg%}

-  **版本**  : 有 4（IPv4）和 6（IPv6）两个值；

-  **首部长度**  : 占 4 位，因此最大值为 15。值为 1 表示的是 1 个 32 位字的长度，也就是 4 字节。因为固定部分长度为 20 字节，因此该值最小为 5。如果可选字段的长度不是 4 字节的整数倍，就用尾部的填充部分来填充。

-  **区分服务**  : 用来获得更好的服务，一般情况下不使用。

-  **总长度**  : 包括首部长度和数据部分长度。

-  **生存时间**  ：TTL，它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，当 TTL 为 0 时就丢弃数据报。

-  **协议** ：指出携带的数据应该上交给哪个协议进行处理，例如 ICMP、TCP、UDP 等。

-  **首部检验和** ：因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量。

-  **标识**  : 在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符。

-  **片偏移**  : 和标识符一起，用于发生分片的情况。片偏移的单位为 8 字节。

{%asset_img 03.png%}

# ==IP 地址编址方式==

IP 地址的编址方式经历了三个历史阶段：

{%asset_img 04.png%}

## 1. 分类

由两部分组成，网络号和主机号，其中不同分类具有不同的网络号长度，并且是固定的。

IP 地址 ::= {< 网络号 >, < 主机号 >}

{%asset_img 05.jpg%}

## 2. 子网划分

通过在主机号字段中拿一部分作为子网号，把两级 IP 地址划分为三级 IP 地址。

IP 地址 ::= {< 网络号 >, < 子网号 >, < 主机号 >}

要使用子网，必须配置子网掩码。

{%asset_img 06.jpg%}

{%asset_img 07.jpg%}

{%asset_img 08.jpg%}

{%asset_img 09.jpg%}

{%asset_img 10.jpg%}

{%asset_img 11.jpg%}

{%asset_img 12.jpg%}

{%asset_img 13.jpg%}

{%asset_img 14.jpg%}

{%asset_img 15.jpg%}

{%asset_img 16.jpg%}

{%asset_img 17.jpg%}

{%asset_img 18.jpg%}

注意，外部网络看不到子网的存在。

## 3. 无分类

无分类编址 CIDR 消除了传统 A 类、B 类和 C 类地址以及划分子网的概念，使用网络前缀和主机号来对 IP 地址进行编码，网络前缀的长度可以根据需要变化。

IP 地址 ::= {< 网络前缀号 >, < 主机号 >}

CIDR 的记法上采用在 IP 地址后面加上网络前缀长度的方法，例如 128.14.35.7/20 表示前 20 位为网络前缀。

CIDR 的地址掩码可以继续称为子网掩码，子网掩码首 1 长度为网络前缀的长度。

一个 CIDR 地址块中有很多地址，一个 CIDR 表示的网络就可以表示原来的很多个网络，并且在路由表中只需要一个路由就可以代替原来的多个路由，减少了路由表项的数量。把这种通过使用网络前缀来减少路由表项的方式称为路由聚合，也称为  **构成超网** 。

在路由表中的项目由“网络前缀”和“下一跳地址”组成，在查找时可能会得到不止一个匹配结果，应当采用最长前缀匹配来确定应该匹配哪一个。

{%asset_img 19.jpg%}

{%asset_img 20.jpg%}

{%asset_img 21.jpg%}

{%asset_img 22.jpg%}

{%asset_img 23.jpg%}

{%asset_img 24.jpg%}

{%asset_img 25.jpg%}

# ==地址解析协议 ARP==

网络层实现主机之间的通信，而链路层实现具体每段链路之间的通信。因此在通信过程中，IP 数据报的源地址和目的地址始终不变，而 MAC 地址随着链路的改变而改变。

{%asset_img 26.jpg%}

ARP 实现由 IP 地址得到 MAC 地址。

{%asset_img 27.jpg%}

### ARP过程（重要）

每个主机都有一个 ARP 缓存，里面有本局域网上的各主机和路由器的 **IP 地址到 MAC 地址的映射表。**

主机 A 知道主机 B 的 IP 地址：

（1）如果 ARP 缓存中**有**该 IP 地址到 MAC 地址的映射，直接将IP数据包封装后发出去。

（2）如果 ARP 缓存中**没有**该 IP 地址到 MAC 地址的映射，此时**主机 A 通过广播的方式发送 ARP 请求分组**，**主机 B 收到该请求后会发送 ARP 响应分组给主机 A 告知其 MAC 地址**，随后主机 A **向其高速缓存中写入**主机 B 的 IP 地址到 MAC 地址的映射。

{%asset_img 28.png%}

ARP欺骗,用于监听(回复解析的MAC，对真实回复的MAC进行覆盖)，用于让目标机无法接受(传个不存在的MAC)(工具：网络执法官，防止：ARP防火墙)

# ==网际控制报文协议 ICMP==

用于实现链路**连通性测试**和链路追踪，可以实现链路差错报告，属于UDP协议。

ping、tracert 等命令的内部就是用的 icmp 协议。

# ==网络组管理协议 IGMP==

信道分类

点到点：

广播：目标地址全FF 发一个包，所有的都可以接受

组播=多播：



组播类似于频道，例如开视频会议，总部在北京，领导讲话，上海所有员工需要观看，其他地方员工不用看到。

而**IGMP协议是指英文全称（Internet Group Management Protocol）**，网络组管理协议。主要用于**建立和管理多播组，对IP分组广播进行控制。**

协议号： ICMP协议号1       IGMP协议2      TCP  6    UDP  17   IPv6  41  0SPF 89



# **静态路由与动态路由**

现将静态路由和动态路由进行如下比较：

定义：

静态路由：静态路由是在路由器中**设置固定的路由表**；除非网络管理员进行干预，否则静态路由表不会发生变化。

动态路由：由网络中的路由器之间相互通信，传递路由信息，**利用收到的路由信息更新路由表**的路由方式。



优点：

静态路由：简单、高效、可靠、网络安全、转发效率高。

动态路由：灵活，能够适时适应网络结构的变化，无需管理员手工维护，减轻了管理员的工作负担。



缺点：

静态路由：不能灵活的适应网络的动态变化。

动态路由：占用网络带宽（用于传输路由更新信息）。



使用场景：

静态路由：**网络规模不大，拓扑结构固定的网络中。**

动态路由：**网络规模大，网络拓扑机构复杂的网络。**

